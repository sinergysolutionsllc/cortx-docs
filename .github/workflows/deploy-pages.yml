name: deploy-pages

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
    - docs/**
    - scripts/**
    - .github/workflows/deploy-pages.yml
  schedule:
  - cron: 17 3 * * *       # optional nightly sync

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: '1'
      # Use a fine-grained PAT with read access to the service repos (recommended)
      # Add this at org or repo level as a secret: ORG_READ_TOKEN
      ORG_READ_TOKEN: ${{ secrets.ORG_READ_TOKEN }}
      GH_OWNER: sinergysolutionsllc
      # optional: comma-list of services to sync (maps to your org repos)
      SERVICES: gateway,identity,validation,ai-broker,workflow,compliance,ledger,ocr,rag

    steps:
    - name: Checkout docs repo
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Configure auth for cross-repo clones
      if: env.ORG_READ_TOKEN != ''
      run: |
        git config --global url."https://x-access-token:${ORG_READ_TOKEN}@github.com/".insteadOf "https://github.com/"
        echo "::add-mask::${ORG_READ_TOKEN}"

    - name: Sync OpenAPI from service repos
      run: bash scripts/sync_openapi.sh

    - name: Configure Pages
      uses: actions/configure-pages@v5

    - name: Build docs
      run: |
        mkdocs build -d site

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
